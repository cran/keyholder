<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Evgeni Chasnovski" />

<meta name="date" content="2020-05-09" />

<title>Introduction to keyholder</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introduction to keyholder</h1>
<h4 class="author">Evgeni Chasnovski</h4>
<h4 class="date">2020-05-09</h4>



<p><code>keyholder</code> is a package for storing information (<em>keys</em>) about rows of data frame like objects. The common use cases are to track rows of data without modifying it and to backup and restore information about rows. This is done with creating a class <strong>keyed_df</strong> which has special attribute “keys”. Keys are updated according to changes in rows of reference data frame.</p>
<p><code>keyholder</code> is designed to work tightly with <a href="https://github.com/tidyverse/dplyr">dplyr</a> package. All its one- and two-table verbs update keys properly.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">mtcars_tbl &lt;-<span class="st"> </span>mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as_tibble</span>()</a></code></pre></div>
<div id="set-keys" class="section level2">
<h2>Set keys</h2>
<p>The general agreement is that keys are always converted to <a href="http://tibble.tidyverse.org">tibble</a>. In this way one can use multiple variables as keys by binding them.</p>
<p>There are two general ways of creating keys:</p>
<ul>
<li>With assigning. The assigned object will be converted to tibble with <code>as_tibble()</code>. To make sense it should have the same number of rows as reference data frame. There are two functions for assigning: <code>keys&lt;-</code> and <code>assign_keys()</code> which are basically the same. The former use more suitable for interactive use and the latter - for piping with <a href="http://magrittr.tidyverse.org">magrittr</a>’s pipe operator <code>%&gt;%</code>.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">mtcars_tbl_keyed &lt;-<span class="st"> </span>mtcars_tbl</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">keys</span>(mtcars_tbl_keyed) &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(mtcars_tbl_keyed))</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">assign_keys</span>(<span class="kw">tibble</span>(<span class="dt">id =</span> <span class="dv">1</span><span class="op">:</span><span class="kw">nrow</span>(.)))</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; # A keyed object. Keys: id </span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<ul>
<li>With <code>key_by()</code> and its scoped variants (<code>*_all()</code>, <code>*_if()</code> and <code>*_at()</code>). This is similar in its design to <code>dplyr</code>’s <code>group_by()</code>: it takes some columns from reference data frame and makes keys from them. It has two important options: <code>.add</code> (whether to add specified columns to existing keys) and <code>.exclude</code> (whether to exclude specified columns from reference data frame). Grouping is ignored.</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; # A keyed object. Keys: vs, am </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(<span class="kw">starts_with</span>(<span class="st">&quot;c&quot;</span>))</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="co">#&gt; # A keyed object. Keys: cyl, carb </span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb3-20" data-line-number="20"></a>
<a class="sourceLine" id="cb3-21" data-line-number="21">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(<span class="kw">starts_with</span>(<span class="st">&quot;c&quot;</span>), <span class="dt">.exclude =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb3-22" data-line-number="22"><span class="co">#&gt; # A keyed object. Keys: cyl, carb </span></a>
<a class="sourceLine" id="cb3-23" data-line-number="23"><span class="co">#&gt; # A tibble: 32 x 9</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="co">#&gt;     mpg  disp    hp  drat    wt  qsec    vs    am  gear</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-26" data-line-number="26"><span class="co">#&gt; 1  21     160   110  3.9   2.62  16.5     0     1     4</span></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="co">#&gt; 2  21     160   110  3.9   2.88  17.0     0     1     4</span></a>
<a class="sourceLine" id="cb3-28" data-line-number="28"><span class="co">#&gt; 3  22.8   108    93  3.85  2.32  18.6     1     1     4</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31">  <span class="co"># Scoped variants</span></a>
<a class="sourceLine" id="cb3-32" data-line-number="32">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by_all</span>()</a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="co">#&gt; # A keyed object. Keys: mpg, cyl, disp, hp, drat, wt, qsec, vs, am, gear, carb </span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb3-36" data-line-number="36"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-37" data-line-number="37"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-38" data-line-number="38"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-39" data-line-number="39"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb3-41" data-line-number="41"></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"><span class="co"># One can also rename variables before keying by supplying .funs</span></a>
<a class="sourceLine" id="cb3-43" data-line-number="43">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by_if</span>(rlang<span class="op">::</span>is_integerish, <span class="dt">.funs =</span> toupper)</a>
<a class="sourceLine" id="cb3-44" data-line-number="44"><span class="co">#&gt; # A keyed object. Keys: CYL, HP, VS, AM, GEAR, CARB </span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb3-46" data-line-number="46"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb3-47" data-line-number="47"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-48" data-line-number="48"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-49" data-line-number="49"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-50" data-line-number="50"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb3-51" data-line-number="51"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb3-52" data-line-number="52"></a>
<a class="sourceLine" id="cb3-53" data-line-number="53">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by_at</span>(<span class="kw">c</span>(<span class="st">&quot;vs&quot;</span>, <span class="st">&quot;am&quot;</span>))</a>
<a class="sourceLine" id="cb3-54" data-line-number="54"><span class="co">#&gt; # A keyed object. Keys: vs, am </span></a>
<a class="sourceLine" id="cb3-55" data-line-number="55"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb3-56" data-line-number="56"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb3-57" data-line-number="57"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb3-58" data-line-number="58"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-59" data-line-number="59"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb3-60" data-line-number="60"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb3-61" data-line-number="61"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<p>To track rows use <code>use_id()</code> which creates a special key <code>.id</code> with row numbers as values.</p>
<p>To properly unkey object use <code>unkey()</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">mtcars_tbl_keyed &lt;-<span class="st"> </span>mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co"># Good</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">unkey</span>()</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co"># Bad</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="kw">attr</span>(mtcars_tbl_keyed, <span class="st">&quot;keys&quot;</span>) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">mtcars_tbl_keyed</a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; # A keyed object. Keys: there are no keys.</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb4-22" data-line-number="22"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
</div>
<div id="get-keys" class="section level2">
<h2>Get keys</h2>
<p>There are three ways of extracting keys:</p>
<ul>
<li>With <code>keys()</code>. This function always returns a tibble. In case of no keys it returns a tibble with number of rows as in reference data frame and zero columns.</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">keys</span>()</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co">#&gt; # A tibble: 32 x 0</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">keys</span>()</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6"><span class="co">#&gt;      vs    am</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#&gt; 1     0     1</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="co">#&gt; 2     0     1</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10"><span class="co">#&gt; 3     1     1</span></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<ul>
<li>With <code>raw_keys()</code> which is just a wrapper for <code>attr(.tbl, &quot;keys&quot;)</code>.</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">raw_keys</span>()</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">raw_keys</span>()</a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt;      vs    am</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; 1     0     1</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; 2     0     1</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">#&gt; 3     1     1</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<ul>
<li>With <code>pull_key()</code> which works like <code>dplyr</code>’s <code>pull</code> applied to keys:</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull_key</span>(vs)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt;  [1] 0 0 1 1 0 1 0 1 1 1 1 0 0 0 0 0 0 1 1 1 1 0 0 0 0 1 0 1 0 0 0 1</span></a></code></pre></div>
</div>
<div id="manipulate-keys" class="section level2">
<h2>Manipulate keys</h2>
<ul>
<li>Remove certain keys with <code>remove_keys()</code> and its scoped variants. If all keys are removed one can automatically unkey object by setting option <code>.unkey</code> to <code>TRUE</code>.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, mpg) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">remove_keys</span>(vs)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#&gt; # A keyed object. Keys: mpg </span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-8" data-line-number="8"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb8-9" data-line-number="9"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10"></a>
<a class="sourceLine" id="cb8-11" data-line-number="11">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, mpg) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">remove_keys</span>(<span class="kw">everything</span>(), <span class="dt">.unkey =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb8-15" data-line-number="15"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-16" data-line-number="16"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-17" data-line-number="17"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb8-19" data-line-number="19"></a>
<a class="sourceLine" id="cb8-20" data-line-number="20">  <span class="co"># Scoped variants</span></a>
<a class="sourceLine" id="cb8-21" data-line-number="21"><span class="co"># Identical to previous one</span></a>
<a class="sourceLine" id="cb8-22" data-line-number="22">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, mpg) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">remove_keys_all</span>(<span class="dt">.unkey =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb8-23" data-line-number="23"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb8-24" data-line-number="24"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb8-25" data-line-number="25"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb8-26" data-line-number="26"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-27" data-line-number="27"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-28" data-line-number="28"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb8-29" data-line-number="29"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb8-30" data-line-number="30"></a>
<a class="sourceLine" id="cb8-31" data-line-number="31">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, mpg) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">remove_keys_if</span>(rlang<span class="op">::</span>is_integerish)</a>
<a class="sourceLine" id="cb8-32" data-line-number="32"><span class="co">#&gt; # A keyed object. Keys: mpg </span></a>
<a class="sourceLine" id="cb8-33" data-line-number="33"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb8-34" data-line-number="34"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb8-35" data-line-number="35"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb8-36" data-line-number="36"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-37" data-line-number="37"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb8-38" data-line-number="38"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb8-39" data-line-number="39"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<ul>
<li>Restore certain keys with <code>restore_keys()</code> and its scoped variants. Restoring means creating or modifying a column in reference data frame with values taken from keys. After restoring certain key one can remove it from keys by setting <code>.remove</code> to <code>TRUE</code>. There is also an option <code>.unkey</code> identical to one in <code>remove_keys()</code> (which is meaningful only in case <code>.remove</code> is <code>TRUE</code>).</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">mtcars_tbl_keyed &lt;-<span class="st"> </span>mtcars_tbl <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="st">  </span><span class="kw">key_by</span>(vs, mpg) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">vs =</span> <span class="dv">1</span>, <span class="dt">mpg =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">mtcars_tbl_keyed</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; # A keyed object. Keys: vs, mpg </span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co">#&gt; 1     0     6   160   110  3.9   2.62  16.5     1     1     4     4</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co">#&gt; 2     0     6   160   110  3.9   2.88  17.0     1     1     4     4</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co">#&gt; 3     0     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"></a>
<a class="sourceLine" id="cb9-14" data-line-number="14">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys</span>(vs)</a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co">#&gt; # A keyed object. Keys: vs, mpg </span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-19" data-line-number="19"><span class="co">#&gt; 1     0     6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-20" data-line-number="20"><span class="co">#&gt; 2     0     6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-21" data-line-number="21"><span class="co">#&gt; 3     0     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-22" data-line-number="22"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb9-23" data-line-number="23"></a>
<a class="sourceLine" id="cb9-24" data-line-number="24">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys</span>(vs, <span class="dt">.remove =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-25" data-line-number="25"><span class="co">#&gt; # A keyed object. Keys: mpg </span></a>
<a class="sourceLine" id="cb9-26" data-line-number="26"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-27" data-line-number="27"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-29" data-line-number="29"><span class="co">#&gt; 1     0     6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-30" data-line-number="30"><span class="co">#&gt; 2     0     6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-31" data-line-number="31"><span class="co">#&gt; 3     0     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-32" data-line-number="32"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb9-33" data-line-number="33"></a>
<a class="sourceLine" id="cb9-34" data-line-number="34">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys</span>(vs, mpg, <span class="dt">.unkey =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-35" data-line-number="35"><span class="co">#&gt; # A keyed object. Keys: vs, mpg </span></a>
<a class="sourceLine" id="cb9-36" data-line-number="36"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-37" data-line-number="37"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-38" data-line-number="38"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-39" data-line-number="39"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-40" data-line-number="40"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-41" data-line-number="41"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-42" data-line-number="42"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb9-43" data-line-number="43"></a>
<a class="sourceLine" id="cb9-44" data-line-number="44">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys</span>(vs, mpg, <span class="dt">.remove =</span> <span class="ot">TRUE</span>, <span class="dt">.unkey =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-45" data-line-number="45"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-46" data-line-number="46"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-47" data-line-number="47"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-48" data-line-number="48"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-49" data-line-number="49"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-50" data-line-number="50"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-51" data-line-number="51"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb9-52" data-line-number="52"></a>
<a class="sourceLine" id="cb9-53" data-line-number="53">  <span class="co"># Scoped variants</span></a>
<a class="sourceLine" id="cb9-54" data-line-number="54">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys_all</span>()</a>
<a class="sourceLine" id="cb9-55" data-line-number="55"><span class="co">#&gt; # A keyed object. Keys: vs, mpg </span></a>
<a class="sourceLine" id="cb9-56" data-line-number="56"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-57" data-line-number="57"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-58" data-line-number="58"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-59" data-line-number="59"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-60" data-line-number="60"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-61" data-line-number="61"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-62" data-line-number="62"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb9-63" data-line-number="63"></a>
<a class="sourceLine" id="cb9-64" data-line-number="64">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys_if</span>(rlang<span class="op">::</span>is_integerish, <span class="dt">.remove =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-65" data-line-number="65"><span class="co">#&gt; # A keyed object. Keys: mpg </span></a>
<a class="sourceLine" id="cb9-66" data-line-number="66"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb9-67" data-line-number="67"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb9-68" data-line-number="68"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb9-69" data-line-number="69"><span class="co">#&gt; 1     0     6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-70" data-line-number="70"><span class="co">#&gt; 2     0     6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb9-71" data-line-number="71"><span class="co">#&gt; 3     0     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb9-72" data-line-number="72"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<p>One important feature of <code>restore_keys()</code> is that restoring keys beats ‘not-modifying’ grouping variables rule. It is made according to the ideology of keys: they contain information about rows and by restoring you want it to be available. Groups are recomputed after restoring.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(vs, mpg)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt; # A keyed object. Keys: vs, mpg </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="co">#&gt; # Groups:   vs, mpg [1]</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt; 1     0     6   160   110  3.9   2.62  16.5     1     1     4     4</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="co">#&gt; 2     0     6   160   110  3.9   2.88  17.0     1     1     4     4</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co">#&gt; 3     0     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"></a>
<a class="sourceLine" id="cb10-12" data-line-number="12">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(vs, mpg) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">restore_keys</span>(vs, mpg)</a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="co">#&gt; # A keyed object. Keys: vs, mpg </span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="co">#&gt; # Groups:   vs, mpg [26]</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
<ul>
<li>Rename keys with <code>rename_keys()</code> and its scoped variants. Renaming is done with <code>dplyr</code>’s <code>rename()</code> or its scoped variant and so renaming format comes from them.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename_keys</span>(<span class="dt">Vs =</span> vs)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; # A keyed object. Keys: Vs, am </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">  <span class="co"># Scoped variants</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rename_keys_all</span>(<span class="dt">.funs =</span> toupper)</a>
<a class="sourceLine" id="cb11-13" data-line-number="13"><span class="co">#&gt; # A keyed object. Keys: VS, AM </span></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="co">#&gt;     mpg   cyl  disp    hp  drat    wt  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="co">#&gt; # … with 29 more rows</span></a></code></pre></div>
</div>
<div id="react-to-subset" class="section level2">
<h2>React to subset</h2>
<p>A method for subsetting function <code>[</code> is implemented for <code>keyed_df</code> to react on changes in rows: if rows in reference data frame are rearranged or removed the same operation is done to keys.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">mtcars_tbl_subset &lt;-<span class="st"> </span>mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  `</span><span class="dt">[</span><span class="st">`</span>(<span class="kw">c</span>(<span class="dv">3</span>, <span class="dv">18</span>, <span class="dv">19</span>), <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">8</span>, <span class="dv">9</span>))</a>
<a class="sourceLine" id="cb12-3" data-line-number="3"></a>
<a class="sourceLine" id="cb12-4" data-line-number="4">mtcars_tbl_subset</a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#&gt; # A keyed object. Keys: vs, am </span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#&gt; # A tibble: 3 x 3</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#&gt;     cyl    vs    am</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt; 1     4     1     1</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt; 2     4     1     1</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt; 3     4     1     1</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="kw">keys</span>(mtcars_tbl_subset)</a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt; # A tibble: 3 x 2</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt;      vs    am</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#&gt; 1     1     1</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#&gt; 2     1     1</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#&gt; 3     1     1</span></a></code></pre></div>
</div>
<div id="verbs-from-dplyr" class="section level2">
<h2>Verbs from dplyr</h2>
<p>All one- and two-table verbs from <code>dplyr</code> (with present scoped variants) support <code>keyed_df</code>. Most functions react to changes in rows as in <code>[</code> but some functions (<code>summarise()</code>, <code>distinct()</code> and <code>do()</code>) unkey object.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">mtcars_tbl_keyed &lt;-<span class="st"> </span>mtcars_tbl <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(vs, am)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(gear, mpg)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#&gt; # A keyed object. Keys: vs, am </span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#&gt;    gear   mpg</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#&gt; 1     4  21  </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt; 2     4  21  </span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt; 3     4  22.8</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">meanMPG =</span> <span class="kw">mean</span>(mpg))</a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; # A tibble: 1 x 1</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt;   meanMPG</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt;     &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#&gt; 1    20.1</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(vs <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">keys</span>()</a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co">#&gt; # A tibble: 14 x 2</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="co">#&gt;      vs    am</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="co">#&gt; 1     1     1</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24"><span class="co">#&gt; 2     1     0</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25"><span class="co">#&gt; 3     1     0</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26"><span class="co">#&gt; # … with 11 more rows</span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27"></a>
<a class="sourceLine" id="cb13-28" data-line-number="28">mtcars_tbl_keyed <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange_at</span>(<span class="st">&quot;mpg&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">keys</span>()</a>
<a class="sourceLine" id="cb13-29" data-line-number="29"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30"><span class="co">#&gt;      vs    am</span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32"><span class="co">#&gt; 1     0     0</span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="co">#&gt; 2     0     0</span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34"><span class="co">#&gt; 3     0     0</span></a>
<a class="sourceLine" id="cb13-35" data-line-number="35"><span class="co">#&gt; # … with 29 more rows</span></a>
<a class="sourceLine" id="cb13-36" data-line-number="36"></a>
<a class="sourceLine" id="cb13-37" data-line-number="37">band_members <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">key_by</span>(name) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38"><span class="st">  </span><span class="kw">semi_join</span>(band_instruments, <span class="dt">by =</span> <span class="st">&quot;name&quot;</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-39" data-line-number="39"><span class="st">  </span><span class="kw">keys</span>()</a>
<a class="sourceLine" id="cb13-40" data-line-number="40"><span class="co">#&gt; # A tibble: 2 x 1</span></a>
<a class="sourceLine" id="cb13-41" data-line-number="41"><span class="co">#&gt;   name </span></a>
<a class="sourceLine" id="cb13-42" data-line-number="42"><span class="co">#&gt;   &lt;chr&gt;</span></a>
<a class="sourceLine" id="cb13-43" data-line-number="43"><span class="co">#&gt; 1 John </span></a>
<a class="sourceLine" id="cb13-44" data-line-number="44"><span class="co">#&gt; 2 Paul</span></a></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
